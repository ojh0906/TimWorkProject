# DESIGN.md — 건설 도면 탐색 UI 설계 과정

---

## 1. 데이터 분석

### 1.1 metadata.json 해석 및 데이터 구조 이해

메타데이터의 최상위 계층은 다음과 같이 이해하였습니다.

```
metadata.json
├── project          # 프로젝트 기본 정보
├── disciplines     # 공종 목록 (건축, 구조, 설비 등)
└── drawings        # 도면 맵 (키: 도면 id)
    ├── "00"        # 전체 배치도
    ├── "01"        # 101동 지상1층 평면도
    └── ...
```

도면은 `parent`로 상위 도면(예: 전체 배치도 `00`)과 연결되며, `position.vertices`로 상위 도면 위의 다각형 영역을 나타냅니다.

| 구분 | 설명 |
|------|------|
| **도면(Drawing)** | `id`, `name`, `image`, `parent`, `position`이 기본 필드이며, `disciplines`가 있으면 공종별 세부 데이터를 가집니다. 전체 배치도(`00`)는 `disciplines`가 없고, 하위 동별 도면만 `disciplines`를 가집니다. |
| **공종(Discipline)** | `image`, `revisions[]`, `regions`, `imageTransform`, `polygon` 등이 선택적입니다. 일부 도면(예: 주차장 확대 평면도)은 프로젝트에는 건축이 있으나 해당 도면의 `disciplines`에는 건축 키가 없어, "건축"을 목록에 넣되 도면 기본 이미지를 쓰는 특수 케이스를 두었습니다. |
| **리비전(Revision)** | `version`, `image`, `date`, `description`, `imageTransform`, `polygon` 등입니다. Region이 있는 공종(예: 101동 구조 A/B)은 영역별로 다른 리비전 배열을 가집니다. |
| **두 가지 Transform** | `imageTransform`은 이미지를 기준 도면 위에 정렬할 때 사용하고, `polygonTransform`(또는 revision/region 내 polygon)은 폴리곤을 화면에 그릴 때 사용합니다. 도면 오버레이와 배치도 클릭 영역 렌더링에서 각각 적용하였습니다. |

리비전·영역 계층은 예를 들어 다음과 같습니다.

```
101동 지상1층 평면도 (drawing "01")
├── 건축    → revisions: REV1
├── 구조    → regions
│   ├── A   → revisions: REV1A, REV2A
│   └── B   → revisions: REV1B, REV2B
├── 공조설비 → revisions
└── ...
```

### 1.2 더 나은 데이터 표현에 대한 생각

| 주제 | 현재 구조 | 개선 방향 |
|------|-----------|------------|
| **도면–공종 관계** | 도면 객체 안에 `disciplines`로 공종이 중첩되어 있어, "이 공종이 어떤 도면들에 있는지" 역참조가 어렵습니다. | 공종을 일급으로 두고 도면과의 관계를 별도 맵으로 두면 검색/필터 구현이 수월할 수 있습니다. |
| **리비전 일관성** | `Original`이 명시적 키가 아닌 경우가 있어, "현재 선택 공종/영역의 베이스 이미지"를 도면 기본 `image`로 통일하는 규칙을 코드에서 정의하였습니다. | 메타데이터에 `baseImage` 또는 `Original` 버전을 명시하면 해석이 단순해질 수 있습니다. |
| **relativeTo 기준** | `imageTransform.relativeTo`가 파일명으로 되어 있습니다. | 도면 추가/이름 변경 시 참조 무결성을 스키마나 툴로 검증하면 유지보수에 유리합니다. |

---

## 2. 접근 방식

과제는 아래 순서와 단계로 접근하였습니다.

```
1단계: 데이터 로드 및 기본 탐색
   ↓
2단계: 공종·리비전·영역 선택 흐름
   ↓
3단계: 컨텍스트 인식 (현재 도면/공종/리비전 표시)
   ↓
4단계: 비교·오버레이 기능
   ↓
5단계: 부가 기능 (핀, 마크업, 줌/팬, 다크 모드 등)
```

| 단계 | 내용 |
|------|------|
| **1단계** | `metadata.json`을 fetch한 뒤, 도면 목록(필터/검색)과 선택 상태(`selectedDrawingId`)를 두고, 선택한 도면의 기본 이미지를 표시하는 흐름을 먼저 구현하였습니다. |
| **2단계** | 선택 도면의 `disciplines`를 파싱하여 **공종 선택 → (있으면) 영역(Region) 선택 → 해당 공종/영역의 리비전 목록**을 드롭다운으로 노출하고, 선택한 리비전에 맞는 이미지 경로를 계산하도록 하였습니다. Region이 있는 경우 "해당 영역의 선택 리비전 이미지"를 메인으로 보여 주고, 패치 오버레이는 사용하지 않도록 분기하였습니다. |
| **3단계** | 상단에 현재 도면명·공종·리비전을 표시하고, 전체 배치도일 때는 `position.vertices`로 하위 도면 폴리곤을 그려 클릭 시 해당 도면으로 이동하도록 하였습니다. 구버전 검토 시 "최신본 바로가기" 배너를 두어 컨텍스트를 명확히 하였습니다. |
| **4단계** | 리비전 비교(단일 오버레이 + 투명도, 스와이프 분할 비교), 타 공종 오버레이(선택 공종 외 공종을 반투명으로 겹쳐 보기)를 추가하였습니다. 비교 시 비교 대상 이미지와 메인 이미지를 분리해 표시하고, 분할 모드에서는 `clipPath`로 좌우를 나누어 그렸습니다. |
| **5단계** | 핀(이슈 기록), 선 그리기 마크업(도면/실세계 좌표 전환), 줌/팬, 다크 모드 등을 추가하였습니다. 전체 배치도처럼 `disciplines`가 없는 도면에서 `selectedDiscipline`만 남아 있을 때 `drawing.disciplines`를 참조해 오류가 나는 엣지 케이스를 찾아, 해당 computed에서 `drawing.disciplines` 존재 여부를 검사하도록 수정하였습니다. |

---

## 3. UI 설계 결정

### 3.1 선택한 레이아웃과 이유

**채택한 레이아웃**

- **좌측 사이드바** — 도면 목록
- **메인 캔버스** — 현재 선택한 도면 이미지 1장에 집중
- **상단 헤더** — 공종/리비전/영역 드롭다운 ("어느 도면 → 어떤 공종 → 어떤 리비전"이 한눈에 보이도록)
- **오른쪽 오버레이 패널** — 비교, 오버레이, 줌, 마크업/핀 등 도구

이렇게 한 이유는, 사용자 시나리오(최신 도면 확인, 공종 간 겹쳐 보기, 리비전 추적)가 모두 **"특정 도면을 먼저 고른 뒤, 그 위에서 공종/리비전을 바꾸거나 겹쳐 보기"**로 수렴한다고 판단했기 때문입니다. 도면 목록을 왼쪽에 두면 동·건물 단위로 찾기가 자연스럽고, 메인을 하나만 쓰면 비교/오버레이 시 레이어 순서와 투명도 제어가 단순해집니다.

### 3.2 고려했던 대안과 장단점

| 대안 | 설명 | 장점 | 단점 | 채택 여부 |
|------|------|------|------|------------|
| **탭 분리** | 도면 탭, 공종 탭, 리비전 탭을 나누는 방식 | 구조가 명확해 보임 | "지금 보는 게 어떤 도면의 어떤 공종인지" 연결이 약해지고, 탭 전환 횟수가 늘어날 수 있음 | 미채택 — 도면 선택 후 같은 화면에서 공종/리비전 드롭다운만 변경하여 컨텍스트를 유지하였습니다. |
| **그리드/멀티 뷰** | 여러 도면을 동시에 타일로 배치 | 병렬 비교에 유리함 | 화면이 잘게 쪼개지고, 각 뷰의 줌/팬 상태를 따로 관리해야 해 복잡도가 커짐 | 미채택 — "단일 메인 + 비교 모드에서 스와이프 또는 오버레이"로 제한하였습니다. |
| **오른쪽 사이드바에 공종/리비전** | 도면 목록 왼쪽, 속성/리비전 오른쪽 | 속성 패널을 넓게 쓸 수 있음 | 좌우 모두 사이드바가 있으면 메인 캔버스가 좁아짐 | 미채택 — 오른쪽은 "도구 모음"만 두고, 공종/리비전은 상단에 두어 캔버스 폭을 확보하였습니다. |

---

## 4. 기술 선택

| 구분 | 선택 내용 | 이유 |
|------|-----------|------|
| **프레임워크** | Vue 3 + TypeScript | 과제 요구(React 18+ 또는 Vue 3+, TypeScript)에 맞추었습니다. 도면/공종/리비전 등 타입이 많은 데이터를 다루기 위해 `Drawing`, `DisciplineData`, `Revision` 등의 인터페이스를 정의하여 메타데이터 해석과 computed 반환 타입을 명확히 하였습니다. |
| **상태 관리** | Composition API + composable (`useDrawing()` 등) | Pinia 등 외부 라이브러리 없이 처리하였습니다. `useDrawing()`에서 도면/공종/리비전/영역 선택, 현재 이미지, 비교·오버레이 관련 상태와 computed를 한곳에 두고, `App.vue`에서만 구독하도록 하였습니다. 도면 선택에 따라 파생되는 값은 대부분 computed로 두고, 도면 변경 시 리셋해야 하는 값(예: 오버레이 활성화)은 `watch`로 정리하였습니다. 핀·마크업은 도면별로 묶어 로컬 상태로 두고, `localStorage`에 저장해 유지하였습니다. |
| **스타일링** | Tailwind CSS | 반응형(사이드바 토글, 모바일에서 패널 접기)과 다크 모드 전환을 클래스 조합으로 처리하였습니다. 도면 컨테이너의 드래그/줌/터치 동작은 Vue ref와 이벤트 리스너로 직접 구현하였고, 비교 분할·오버레이 순서 등 복잡한 레이아웃은 인라인 스타일 또는 Tailwind와 혼용하여 필요한 부분만 제어하였습니다. |

코드 상에서의 역할 분리는 예를 들어 다음과 같습니다.

```ts
// useDrawing.ts — 도면/공종/리비전/오버레이 상태 및 computed
selectedDrawingId, selectedDiscipline, selectedRegion, selectedRevision
currentImage, renderedOverlays, compareImage, ...
```

```ts
// App.vue — 구독 및 UI 바인딩
const { currentImage, renderedOverlays, ... } = useDrawing()
```

---

## 5. 어려웠던 점 및 개선 방안

과제를 진행하면서 겪었던 어려움을, **가장 힘들었던 것부터** 쉽게 풀어서 정리하였습니다.

---

### 5.1 Region A/B 레이어 오버레이 문제 (가장 어려웠던 부분)

**상황**  
101동 지상1층 평면도에서 **건축** 공종을 선택한 뒤, 레이어 오버레이 기능으로 **구조** 공종을 겹쳐 보려고 하면, 화면이 이상하게 나오는 문제가 있었습니다. 구조 공종은 도면을 **Region A**와 **Region B** 두 영역으로 나누어 리비전을 관리하는데, 오버레이 시 **A 영역 이미지와 B 영역 이미지가 동시에** 도면 위에 그려지면서 서로 겹치고, 레이아웃이 깨져 보였습니다.

**원인**  
오버레이용 이미지를 만드는 로직(`renderedOverlays`)에서, “구조”처럼 `regions`가 있는 공종에 대해 **베이스 이미지 1장 + Region A 리비전 이미지 1장 + Region B 리비전 이미지 1장**을 모두 배열에 넣고 있었습니다. 그래서 건축 도면 위에 구조 베이스 + A + B가 한꺼번에 올라가면서, 각각의 위치/변환 정보가 겹쳐 화면이 어긋나 보였습니다.

**해결**  
“다른 공종을 **오버레이**로 켤 때”는, 그 공종에 Region이 있더라도 **Region A/B 패치를 추가하지 않고**, 해당 공종의 **베이스 이미지(또는 root 리비전) 한 장만** 그리도록 수정하였습니다. 이렇게 하면 “건축 위에 구조 전체 도면 1장”만 겹쳐져서, 화면이 깔끔하게 나옵니다.

**정리**

| 구분 | 내용 |
|------|------|
| **어려웠던 점** | Region이 있는 공종을 오버레이로 켰을 때, A/B 두 영역 이미지가 동시에 그려지며 레이아웃이 깨짐 |
| **개선한 방법** | 오버레이 시에는 Region 패치를 넣지 않고, 해당 공종의 베이스(또는 root) 이미지 1장만 표시 |

---

### 5.2 전체 배치도로 돌아올 때 오류 (엣지 케이스)

**상황**  
다른 도면(예: 101동)을 보고 있다가 다시 **전체 배치도**를 선택하면, 화면에 오류가 나며 이미지가 안 보이는 경우가 있었습니다.

**원인**  
전체 배치도(`00`)에는 `disciplines`가 없습니다. 그런데 이전에 101동에서 “건축”을 선택한 상태로 두고 전체 배치도로 돌아오면, **선택된 공종(건축)** 은 그대로인데 **현재 도면에는 공종 데이터가 없는** 상태가 됩니다. 이때 코드에서 `drawing.disciplines['건축']`처럼 접근하면 `drawing.disciplines`가 `undefined`라서 **Cannot read properties of undefined** 오류가 발생하였습니다.

**해결**  
`drawing.disciplines`를 사용하는 모든 computed에서, **먼저 “이 도면에 disciplines가 있는지”** 검사하도록 바꾸었습니다. 없으면 바로 `null`이나 빈 배열을 반환해서, 전체 배치도에서도 오류 없이 동작하도록 하였습니다.

---

### 5.3 리비전·오버레이·비교가 섞일 때

**상황**  
“메인 이미지 = 선택한 영역(Region)의 리비전 이미지”로 맞춘 뒤에도, **타 공종 오버레이**나 **리비전 비교 모드**를 같이 켜면, 어떤 이미지를 먼저 그려야 할지·어떤 URL을 써야 할지 헷갈리는 경우가 있었습니다.

**해결**  
역할을 나누어 “**메인 1장 + 비교용 1장 + 오버레이 N장**”으로 계산하도록 정리하였습니다. 각각을 별도 computed에서 만들고, 화면에 그릴 때 순서와 투명도만 맞추면 되도록 하였습니다.

---

### 5.4 터치 시 드래그와 선 그리기 충돌

**상황**  
모바일처럼 터치로 사용할 때, **도면을 손가락으로 움직이는 동작(팬)** 과 **선 그리기**가 동시에 반응해서, 의도와 다르게 선이 그려지거나 도면이 움직이는 경우가 있었습니다.

**해결**  
선 그리기(마크업) 모드일 때만 선 그리기 이벤트를 받고, 그때는 컨테이너에 `touch-action: none`을 주어 스크롤/팬이 섞이지 않도록 하였습니다. 또 선을 선택할 때 쓰는 터치 영역을 줄여서, 다른 동작과 덜 겹치도록 조정하였습니다.

---

### 5.5 템플릿 태그 짝 맞추기

**상황**  
오버레이 패널이 리비전 드롭다운 뒤에 가려지지 않도록, 레이아웃과 `z-index`·DOM 순서를 바꾸는 과정에서 **닫는 태그가 하나 어긋나**, Vue에서 “Element is missing end tag” 컴파일 오류가 난 적이 있습니다.

**해결**  
열린 태그와 닫는 태그를 다시 맞춰 수정하였습니다. 앞으로는 헤더·캔버스·패널을 작은 컴포넌트로 나누어, 한 파일 안의 태그 수를 줄이면 이런 실수가 줄어들 것 같습니다.

---
